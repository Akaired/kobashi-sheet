(async()=>{const mount=document.getElementById("kb-stage");if(!mount)return;if(mount.dataset.kobashiInit==="1")return;mount.dataset.kobashiInit="1";if(mount.querySelector("canvas"))return;const W=720,H=720,IMG_A="https://i.imgur.com/WBM4T7S.png",IMG_B="https://i.imgur.com/tFFXneb.png",IMG_PAGE="https://i.imgur.com/mynccVj.png",IMG_COVER="https://i.imgur.com/kxLLJmE.png",JSON_URL="https://akaired.github.io/kobashi-sheet/diary.json";try{if(document.fonts&&document.fonts.ready)await document.fonts.ready}catch(e){}if(typeof PIXI==="undefined"){console.error("PIXI non definito: pixi.js non caricato");return}const app=new PIXI.Application();await app.init({width:W,height:H,backgroundAlpha:0,antialias:true,resolution:window.devicePixelRatio||1,autoDensity:true});mount.appendChild(app.canvas);const stage=new PIXI.Container();app.stage.addChild(stage);const sceneIntro=new PIXI.Container(),sceneDiary=new PIXI.Container();stage.addChild(sceneIntro);stage.addChild(sceneDiary);sceneDiary.visible=false;const root=new PIXI.Container(),scene=new PIXI.Container(),overlay=new PIXI.Container(),fog=new PIXI.Container(),textFX=new PIXI.Container();sceneIntro.addChild(root);root.addChild(scene);root.addChild(overlay);root.addChild(fog);root.addChild(textFX);scene.addChild(new PIXI.Graphics().rect(0,0,W,H).fill(0x050505));const texA=await PIXI.Assets.load(IMG_A),texB=await PIXI.Assets.load(IMG_B);const spriteA=new PIXI.Sprite(texA),spriteB=new PIXI.Sprite(texB);function fitCover(s){s.anchor.set(.5);s.x=W/2;s.y=H/2;const tw=s.texture.width||1,th=s.texture.height||1,sc=Math.max(W/tw,H/th);s.scale.set(sc)}fitCover(spriteA);fitCover(spriteB);spriteA.alpha=1;spriteB.alpha=0;scene.addChild(spriteA);scene.addChild(spriteB);let hover=false;const fadeSpeed=.09;mount.addEventListener("mouseenter",()=>hover=true);mount.addEventListener("mouseleave",()=>hover=false);const sf=W/1024,box={x1:357*sf,y1:560*sf,x2:580*sf,y2:825*sf};const inside=(x,y)=>x>=box.x1&&x<=box.x2&&y>=box.y1&&y<=box.y2;const flash=new PIXI.Graphics().rect(0,0,W,H).fill(0xFFFFFF);flash.alpha=0;overlay.addChild(flash);const vig=new PIXI.Graphics().rect(0,0,W,H).fill(0x000000);vig.alpha=.18;vig.blendMode="multiply";overlay.addChild(vig);const fog1=new PIXI.Graphics(),fog2=new PIXI.Graphics();function drawFog(g,sx,sy,d){g.clear();g.beginFill(0xFFFFFF,.095);for(let i=0;i<d;i++){const x=(Math.random()*W)+sx,y=(Math.random()*H)+sy,r=40+Math.random()*110;g.drawCircle(x%(W+200)-100,y%(H+200)-100,r)}g.endFill()}drawFog(fog1,0,0,32);drawFog(fog2,140,80,26);fog1.alpha=.78;fog2.alpha=.55;fog1.blendMode="screen";fog2.blendMode="screen";fog1.filters=[new PIXI.BlurFilter({strength:8,quality:2})];fog2.filters=[new PIXI.BlurFilter({strength:14,quality:2})];fog.addChild(fog1);fog.addChild(fog2);const lines=["SANGUE","FAME","CONTROLLO","VENDETTA","SOPRAVVIVENZA","JASHIN","NON È DOLORE","PIACERE","RESPIRA"],active=[];function mk(line){const tt=new PIXI.Text({text:line,style:{fontFamily:"Mochiy Pop One",fontSize:28,fill:"#ffffff",stroke:"#000000",strokeThickness:6,letterSpacing:2,dropShadow:true,dropShadowColor:"#000000",dropShadowBlur:2,dropShadowDistance:2}});tt.pivot.set(tt.width/2,tt.height/2);const m=120;tt.x=m+Math.random()*(W-m*2);tt.y=m+Math.random()*(H-m*2);tt.alpha=0;tt.rotation=(Math.random()-.5)*.35;tt.scale.set(.85+Math.random()*.6);return{t:tt,life:80+Math.floor(Math.random()*160),age:0}}function spawn(){if(spriteA.alpha<.92)return;if(active.length>6)return;if(Math.random()<.006){const o=mk(lines[(Math.random()*lines.length)|0]);textFX.addChild(o.t);active.push(o)}}function upd(){for(let i=active.length-1;i>=0;i--){const o=active[i];o.age++;const fi=14,fo=22;o.age<fi?o.t.alpha=o.age/fi:o.age>o.life-fo?o.t.alpha=Math.max(0,(o.life-o.age)/fo):o.t.alpha=1;o.t.x+=(Math.random()-.5)*.35;o.t.y+=(Math.random()-.5)*.35;if(o.age>=o.life){textFX.removeChild(o.t);o.t.destroy();active.splice(i,1)}}}const sig=new PIXI.Container();sig.x=W/2;sig.y=H/2;textFX.addChild(sig);const words=["Sangue","Fame","Controllo","Vendetta","Sopravvivenza"],R=265;let ang=0;const sigT=[];for(let i=0;i<words.length;i++){const tt=new PIXI.Text({text:words[i],style:{fontFamily:"Mochiy Pop One",fontSize:22,fill:"#ffffff",stroke:"#000000",strokeThickness:6,letterSpacing:2}});tt.pivot.set(tt.width/2,tt.height/2);const a=i/words.length*Math.PI*2;tt.x=Math.cos(a)*R;tt.y=Math.sin(a)*R;tt.rotation=a+Math.PI/2;tt.alpha=0;sig.addChild(tt);sigT.push(tt)}function sigUpd(){const ta=spriteB.alpha>.9?1:0;for(const tt of sigT)tt.alpha+=(ta-tt.alpha)*.10;if(sigT[0].alpha>.02){ang+=.007;sig.rotation=ang}}let t=0,sp=0,st=0,ft=0;const imp=()=>Math.random()<.07?st=.9+Math.random()*1.4:st*=.85;app.ticker.add(()=>{t+=.05;if(hover){spriteB.alpha=Math.min(1,spriteB.alpha+fadeSpeed);spriteA.alpha=Math.max(0,spriteA.alpha-fadeSpeed)}else{spriteB.alpha=Math.max(0,spriteB.alpha-fadeSpeed);spriteA.alpha=Math.min(1,spriteA.alpha+fadeSpeed)}imp();sp+=(st-sp)*.12;const nx=(Math.random()-.5)*sp,ny=(Math.random()-.5)*sp,snap=Math.random()<.08?(Math.random()-.5)*1.2:0;root.x=nx+snap;root.y=ny-snap;root.scale.set(1+Math.sin(t*.8)*.006+(Math.random()-.5)*.004);ft*=.1;Math.random()<.035&&(ft+=.10+Math.random()*.10);Math.random()<.010&&(ft+=.22+Math.random()*.18);Math.random()<.003&&(ft+=.45+Math.random()*.25);hover&&(ft*=1.10);flash.alpha+=(Math.min(.45,ft)-flash.alpha)*.12;fog1.x=Math.sin(t*.25)*18;fog1.y=Math.cos(t*.22)*14;fog2.x=Math.cos(t*.18)*22;fog2.y=Math.sin(t*.16)*18;fog1.alpha=.45+Math.sin(t*.35)*.08;fog2.alpha=.30+Math.cos(t*.28)*.07;Math.random()<.02&&drawFog(fog1,Math.random()*200,Math.random()*200,14);Math.random()<.015&&drawFog(fog2,Math.random()*200,Math.random()*200,10);spawn();upd();sigUpd()});function toDiaryScene(){sceneIntro.visible=false;sceneDiary.visible=true;hover=false;mount.style.cursor="default"}function toIntroScene(){sceneDiary.visible=false;sceneIntro.visible=true;hover=false;mount.style.cursor="default"}let diaryData=null;async function loadDiaryJSON(){if(diaryData)return diaryData;const r=await fetch(JSON_URL,{cache:"no-store"});if(!r.ok)throw new Error("JSON non caricato");diaryData=await r.json();diaryData.chapters.sort((a,b)=>(a.order??999)-(b.order??999));return diaryData}function getBlock(page,i){const b=page?.content?.[i];if(!b)return null;if(b.type==="image")return b;if(b.type==="h1")return String(b.text||"").toUpperCase();if(b.type==="p")return String(b.text||"");if(b.type==="list")return b.items.map(x=>"• "+x).join("\n");return""}const diaryRoot=new PIXI.Container();sceneDiary.addChild(diaryRoot);diaryRoot.addChild(new PIXI.Graphics().rect(0,0,W,H).fill(0x050505));const pageTex=await PIXI.Assets.load(IMG_PAGE);const pageSpr=new PIXI.Sprite(pageTex);fitCover(pageSpr);const coverTex=await PIXI.Assets.load(IMG_COVER);const coverSpr=new PIXI.Sprite(coverTex);fitCover(coverSpr);diaryRoot.addChild(pageSpr);diaryRoot.addChild(coverSpr);const ui=new PIXI.Container();diaryRoot.addChild(ui);const TAB_X=26,TAB_Y=78,TAB_W=170,TAB_H=44,TAB_GAP=10;const tabContainer=new PIXI.Container();ui.addChild(tabContainer);const tabItems=[];const contentContainer=new PIXI.Container();ui.addChild(contentContainer);const titleText=new PIXI.Text({text:"",style:{fontFamily:"Cormorant Garamond",fontSize:34,fontWeight:"700",fill:"#2b1b12"}});titleText.x=220;titleText.y=86;contentContainer.addChild(titleText);const bodyText=new PIXI.Text({text:"",style:{fontFamily:"Cormorant Garamond",fontSize:22,fill:"#2b1b12",wordWrap:true,wordWrapWidth:420,lineHeight:28}});bodyText.x=220;bodyText.y=140;contentContainer.addChild(bodyText);let currentImageSprite=null;const nav=new PIXI.Container();ui.addChild(nav);const BTN_W=62,BTN_H=40,BTN_R=10,BTN_Y=H-78,BTN_L=300,BTN_R_X=W-300-BTN_W;const btnPrev=new PIXI.Graphics().roundRect(0,0,BTN_W,BTN_H,BTN_R).fill(0x2b1b12);btnPrev.alpha=.10;btnPrev.x=BTN_L;btnPrev.y=BTN_Y;nav.addChild(btnPrev);const prevLabel=new PIXI.Text({text:"◀",style:{fontFamily:"Cormorant Garamond",fontSize:26,fontWeight:"700",fill:"#f0e1c8"}});prevLabel.x=btnPrev.x+22;prevLabel.y=btnPrev.y+6;nav.addChild(prevLabel);const btnNext=new PIXI.Graphics().roundRect(0,0,BTN_W,BTN_H,BTN_R).fill(0x2b1b12);btnNext.alpha=.10;btnNext.x=BTN_R_X;btnNext.y=BTN_Y;nav.addChild(btnNext);const nextLabel=new PIXI.Text({text:"▶",style:{fontFamily:"Cormorant Garamond",fontSize:26,fontWeight:"700",fill:"#f0e1c8"}});nextLabel.x=btnNext.x+22;nextLabel.y=btnNext.y+6;nav.addChild(nextLabel);btnPrev.eventMode="static";btnNext.eventMode="static";btnPrev.cursor="pointer";btnNext.cursor="pointer";const closeBtn=new PIXI.Graphics().roundRect(0,0,44,44,12).fill(0x2b1b12);closeBtn.alpha=.16;closeBtn.x=W-90;closeBtn.y=36;closeBtn.eventMode="static";closeBtn.cursor="pointer";diaryRoot.addChild(closeBtn);const closeLabel=new PIXI.Text({text:"✕",style:{fontFamily:"Mochiy Pop One",fontSize:18,fill:"#f0e1c8"}});closeLabel.x=closeBtn.x+14;closeLabel.y=closeBtn.y+10;diaryRoot.addChild(closeLabel);closeBtn.on("pointerdown",()=>{showingCover=true;toIntroScene();});let showingCover=true;let state={chapterIndex:0,pageIndex:0,blockIndex:0};function setActiveTab(i){for(let k=0;k<tabItems.length;k++){tabItems[k].bg.alpha=(k===i)?.95:.78;tabItems[k].txt.alpha=(k===i)?1:.92}}async function renderPage(){if(currentImageSprite){contentContainer.removeChild(currentImageSprite);currentImageSprite=null;}const ch=diaryData.chapters[state.chapterIndex];const page=ch.pages[state.pageIndex];const block=page.content[state.blockIndex];if(block&&block.type==="image"){titleText.text="";bodyText.visible=false;const imgTex=await PIXI.Assets.load(block.url);currentImageSprite=new PIXI.Sprite(imgTex);currentImageSprite.x=220;currentImageSprite.y=140;currentImageSprite.width=420;currentImageSprite.height=300;contentContainer.addChild(currentImageSprite);}else{titleText.text=page.title||ch.tabLabel||"";bodyText.text=getBlock(page,state.blockIndex);bodyText.visible=true;}setActiveTab(state.chapterIndex)}function next(){const ch=diaryData.chapters[state.chapterIndex];const page=ch.pages[state.pageIndex];if(state.blockIndex<page.content.length-1){state.blockIndex++;renderPage();return}state.blockIndex=0;if(state.pageIndex<ch.pages.length-1){state.pageIndex++;renderPage();return}if(state.chapterIndex<diaryData.chapters.length-1){state.chapterIndex++;state.pageIndex=0;renderPage()}}function prev(){if(state.blockIndex>0){state.blockIndex--;renderPage();return}if(state.pageIndex>0){state.pageIndex--;const p=diaryData.chapters[state.chapterIndex].pages[state.pageIndex];state.blockIndex=p.content.length-1;renderPage();return}if(state.chapterIndex>0){state.chapterIndex--;const ch=diaryData.chapters[state.chapterIndex];state.pageIndex=ch.pages.length-1;state.blockIndex=ch.pages[state.pageIndex].content.length-1;renderPage()}}btnPrev.on("pointerdown",prev);btnNext.on("pointerdown",next);closeBtn.on("pointerdown",toIntroScene);async function showDiaryContent(){await loadDiaryJSON();buildTabs();state.chapterIndex=0;state.pageIndex=0;state.blockIndex=0;renderPage();}async function openDiary(){toDiaryScene();coverSpr.visible=showingCover;ui.visible=!showingCover;if(showingCover){coverSpr.eventMode="static";coverSpr.cursor="pointer";coverSpr.on("pointerdown",async()=>{showingCover=false;coverSpr.visible=false;ui.visible=true;coverSpr.eventMode="no";coverSpr.cursor="default";await showDiaryContent();});}else{await showDiaryContent();}}function buildTabs(){tabContainer.removeChildren();tabItems.length=0;for(let i=0;i<diaryData.chapters.length;i++){const ch=diaryData.chapters[i];const label=ch.tabLabel||("Capitolo "+(i+1));const y=TAB_Y+i*(TAB_H+TAB_GAP);const bg=new PIXI.Graphics().roundRect(0,0,TAB_W,TAB_H,12).fill(0x5b0f17);bg.x=TAB_X;bg.y=y;bg.alpha=.78;bg.eventMode="static";bg.cursor="pointer";const txt=new PIXI.Text({text:label,style:{fontFamily:"Mochiy Pop One",fontSize:15,fill:"#f4e7d0",stroke:"#000000",strokeThickness:4}});txt.x=TAB_X+16;txt.y=y+11;txt.alpha=.92;tabContainer.addChild(bg);tabContainer.addChild(txt);bg.on("pointerdown",()=>{state.chapterIndex=i;state.pageIndex=0;state.blockIndex=0;renderPage()});tabItems.push({bg,txt})}}mount.addEventListener("mousemove",e=>{if(sceneDiary.visible)return;const r=mount.getBoundingClientRect(),mx=(e.clientX-r.left)*(W/r.width),my=(e.clientY-r.top)*(H/r.height);mount.style.cursor=hover&&inside(mx,my)?"pointer":"default"});mount.addEventListener("click",e=>{if(sceneDiary.visible)return;const r=mount.getBoundingClientRect(),mx=(e.clientX-r.left)*(W/r.width),my=(e.clientY-r.top)*(H/r.height);if(!hover)return;if(inside(mx,my))openDiary()});})();
